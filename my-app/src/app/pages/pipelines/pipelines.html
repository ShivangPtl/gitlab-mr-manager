<div class="home-container">
  <div class="controls">
    <mat-form-field appearance="fill" class="control-item" *ngIf="showBranchSelector">
      <mat-label>Target Branch</mat-label>
      <mat-select [(ngModel)]="targetBranch" (ngModelChange)="refreshPipelines()">
        <mat-option [value]="customSettings?.supportBranch">
          {{ 'Support(' + customSettings?.supportBranch + ')' }}
        </mat-option>
        <mat-option [value]="customSettings?.releaseBranch">
          {{ 'Release(' + customSettings?.releaseBranch + ')' }}
        </mat-option>
        <mat-option [value]="customSettings?.liveBranch">
          {{ 'Live(' + customSettings?.liveBranch + ')' }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div *ngIf="dataSource.data.length > 0; else noData">
    <!-- Table -->
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2 full-width-table">
      <!-- Select -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="col-center"> Select </th>
        <td mat-cell *matCellDef="let row" class="col-center">

          <!-- Show checkbox ONLY if schedule exists -->
          <mat-checkbox [disabled]="!canRun(row)" [checked]="isSelected(row)"
            (change)="toggleSelection(row, $event.checked)">
          </mat-checkbox>

        </td>
      </ng-container>


      <!-- Project Name -->
      <ng-container matColumnDef="project">
        <th mat-header-cell *matHeaderCellDef> Project </th>
        <td mat-cell *matCellDef="let pipeline">
          <app-badge [label]="pipeline.project_name" [type]="getProjectType(pipeline.project_name)"></app-badge>
        </td>
      </ng-container>

      <!-- Triggered By -->
      <ng-container matColumnDef="user">
        <th mat-header-cell *matHeaderCellDef> Triggered By </th>
        <td mat-cell *matCellDef="let pipeline">{{ pipeline.user }}</td>
      </ng-container>

      <!-- Created At -->
      <ng-container matColumnDef="deployed">
        <th mat-header-cell *matHeaderCellDef> Last Deployed At </th>
        <td mat-cell *matCellDef="let pipeline">{{ pipeline.deployed_at }}</td>
      </ng-container>

      <!-- Pipeline Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="col-center"> Status </th>
        <td mat-cell *matCellDef="let pipeline" class="col-center">
          <app-badge [label]="pipeline.status" variant="pill" [type]="pipeline.status">
          </app-badge>
        </td>
      </ng-container>

      <!-- Open MRs -->
      <ng-container matColumnDef="openMRs">
        <th mat-header-cell *matHeaderCellDef class="col-center">
          <span matTooltip="Open Merge Requests targeting this branch">Open MRs</span>
        </th>
        <td mat-cell *matCellDef="let pipeline" class="col-center">
          <app-badge *ngIf="pipeline.openMRs > 0" [label]="pipeline.openMRs" variant="pill" [type]="'pending_mr'">
          </app-badge>
          <span *ngIf="pipeline.openMRs === 0" class="muted">‚Äî</span>
        </td>
      </ng-container>

      <!-- Changes Since Deploy -->
      <ng-container matColumnDef="changes">
        <th mat-header-cell *matHeaderCellDef class="col-center">
          <span matTooltip="Number of commits since last deployment">Changes</span>
        </th>
        <td mat-cell *matCellDef="let pipeline" class="col-center">
          <app-badge *ngIf="pipeline.changesSinceDeploy > 0" [label]="pipeline.changesSinceDeploy" variant="pill" [type]="'changes_after_deployment'">
          </app-badge>
          <span *ngIf="pipeline.changesSinceDeploy === 0" class="muted">‚Äî</span>
        </td>
      </ng-container>

      <!-- Info -->
      <ng-container matColumnDef="info">
        <th mat-header-cell *matHeaderCellDef class="col-center"> Info </th>
        <td mat-cell *matCellDef="let pipeline" class="col-center">
          <button mat-icon-button (click)="openDetails(pipeline.full_pipeline)">
            <mat-icon>info</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- URL -->
      <ng-container matColumnDef="link">
        <th mat-header-cell *matHeaderCellDef class="col-center"> Open </th>
        <td mat-cell *matCellDef="let row" class="col-center">
          <a (click)="openDefaultBrowser(row.link)" class="pointer">üîó</a>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columns"></tr>
      <tr mat-row *matRowDef="let row; columns: columns;"></tr>
    </table>
  </div>

  <ng-template #noData>
    <div class="empty-state">
      <mat-icon>inbox</mat-icon>
      <h3>No Pipelines Yet</h3>
      <p>Pipelines will appear here once they are created</p>
    </div>
  </ng-template>

  <!-- Action Section -->
  <div class="actions">
    <!-- Left: Last Refreshed Info -->
    <div class="refresh-info">
      ‚è±Ô∏è Last refreshed: {{ lastRefreshed | date: 'dd/MM/yyyy hh:mm a' }}
    </div>

    <!-- Right: Buttons -->
    <div class="button-group">
      <button mat-raised-button class="themed-btn" *ngIf="isAdmin" [disabled]="!hasSelectedRows" (click)="runSelected()">
        ‚ñ∂ Run
      </button>
      <button mat-raised-button class="themed-btn" (click)="refreshPipelines()">üîÑ Refresh</button>
    </div>
  </div>

</div>